  <!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>积分管理系统 - 云端版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#FF7D00',
                        success: '#00B42A',
                        danger: '#F53F3F',
                        neutral: {
                            100: '#F2F3F5',
                            200: '#E5E6EB',
                            300: '#C9CDD4',
                            400: '#86909C',
                            500: '#4E5969',
                            600: '#272E3B',
                            700: '#1D2129',
                        }
                    }
                }
            }
        }
    </script>
    
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-fadeIn {
            animation: fadeIn 0.5s ease-out forwards;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .point-change {
            animation: pulse 0.5s ease-out;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .sync-status {
            position: fixed;
            top: 60px;
            right: 20px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 100;
            transition: all 0.3s;
        }
        
        .sync-status.syncing {
            background: #165DFF;
            color: white;
        }
        
        .sync-status.synced {
            background: #00B42A;
            color: white;
        }
        
        .sync-status.error {
            background: #F53F3F;
            color: white;
        }
    </style>
</head>
<body class="font-sans bg-neutral-100 text-neutral-700 min-h-screen flex flex-col">
    <!-- 同步状态指示器 -->
    <div id="sync-status" class="sync-status synced hidden">
        <i class="fa fa-check-circle mr-1"></i>已同步
    </div>

    <!-- 登录模态框 -->
    <div id="login-modal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4 animate-fadeIn">
            <h3 class="text-xl font-bold mb-4 text-neutral-700 flex items-center">
                <i class="fa fa-github mr-2"></i>连接到 GitHub
            </h3>
            <p class="text-neutral-600 mb-4 text-sm">
                请输入你的 GitHub Token 和 Gist ID 来同步数据到云端。
                <a href="https://github.com/settings/tokens" target="_blank" class="text-primary underline">获取 Token</a>
            </p>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-neutral-600 mb-1">GitHub Token</label>
                    <input type="password" id="github-token" class="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary" placeholder="ghp_xxxxxxxxxxxx">
                </div>
                <div>
                    <label class="block text-sm font-medium text-neutral-600 mb-1">Gist ID</label>
                    <input type="text" id="gist-id" class="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary" placeholder="a1b2c3d4e5f6...">
                </div>
            </div>
            
            <div class="mt-6 flex justify-end space-x-3">
                <button id="login-btn" class="w-full px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors flex items-center justify-center">
                    <span>连接并同步</span>
                </button>
            </div>
            
            <div class="mt-4 text-xs text-neutral-500 text-center">
                Token 仅保存在本地浏览器中，不会上传到任何服务器
            </div>
        </div>
    </div>

    <!-- 导航栏 -->
    <header class="bg-white shadow-md sticky top-0 z-40 transition-all duration-300">
        <div class="container mx-auto px-4 py-3">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    <i class="fa fa-star text-secondary text-2xl"></i>
                    <h1 class="text-xl font-bold text-primary">积分管理系统</h1>
                    <span class="text-xs bg-primary/10 text-primary px-2 py-1 rounded-full">云端版</span>
                </div>
                
                <div class="flex items-center space-x-4">
                    <button id="sync-btn" class="text-neutral-600 hover:text-primary transition-colors" title="立即同步">
                        <i class="fa fa-refresh"></i>
                    </button>
                    <button id="logout-btn" class="text-neutral-600 hover:text-danger transition-colors" title="退出">
                        <i class="fa fa-sign-out"></i>
                    </button>
                    
                    <nav class="hidden md:flex space-x-6 ml-4">
                        <button id="nav-points" class="nav-btn active py-2 px-1 border-b-2 border-primary text-primary font-medium">
                            <i class="fa fa-calculator mr-1"></i>积分
                        </button>
                        <button id="nav-redeem" class="nav-btn py-2 px-1 border-b-2 border-transparent hover:text-primary transition-colors">
                            <i class="fa fa-gift mr-1"></i>兑换
                        </button>
                        <button id="nav-tasks" class="nav-btn py-2 px-1 border-b-2 border-transparent hover:text-primary transition-colors">
                            <i class="fa fa-tasks mr-1"></i>任务
                        </button>
                    </nav>
                </div>
                
                <button id="mobile-menu-btn" class="md:hidden text-neutral-700 focus:outline-none">
                    <i class="fa fa-bars text-xl"></i>
                </button>
            </div>
            
            <div id="mobile-menu" class="md:hidden hidden mt-3 pb-2 animate-fadeIn">
                <div class="flex flex-col space-y-3">
                    <button id="mobile-nav-points" class="mobile-nav-btn active py-2 px-4 bg-primary/10 text-primary rounded-md text-left">
                        <i class="fa fa-calculator mr-2"></i>积分
                    </button>
                    <button id="mobile-nav-redeem" class="mobile-nav-btn py-2 px-4 hover:bg-neutral-100 rounded-md text-left">
                        <i class="fa fa-gift mr-2"></i>兑换
                    </button>
                    <button id="mobile-nav-tasks" class="mobile-nav-btn py-2 px-4 hover:bg-neutral-100 rounded-md text-left">
                        <i class="fa fa-tasks mr-2"></i>任务
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- 主内容区 -->
    <main class="flex-grow container mx-auto px-4 py-8">
        <!-- 1. 积分板块 -->
        <section id="points-section" class="section-transition">
            <div class="bg-white rounded-xl p-6 md:p-8 shadow-lg animate-fadeIn">
                <h2 class="text-2xl font-bold text-neutral-700 mb-8 flex items-center">
                    <i class="fa fa-calculator text-primary mr-3"></i>积分管理
                </h2>
                
                <div class="flex flex-col items-center justify-center mb-10">
                    <div class="text-6xl md:text-8xl font-bold text-primary mb-2" id="current-points">0</div>
                    <p class="text-neutral-500">当前可用积分</p>
                </div>
                
                <div class="flex justify-center space-x-6">
                    <button id="add-point" class="bg-success hover:bg-success/90 text-white font-medium py-4 px-10 rounded-xl flex items-center shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-1">
                        <i class="fa fa-plus-circle mr-2 text-xl"></i>加一分
                    </button>
                    <button id="subtract-point" class="bg-danger hover:bg-danger/90 text-white font-medium py-4 px-10 rounded-xl flex items-center shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-1">
                        <i class="fa fa-minus-circle mr-2 text-xl"></i>减一分
                    </button>
                </div>
            </div>
        </section>
        
        <!-- 2. 积分兑换板块 -->
        <section id="redeem-section" class="hidden">
            <div class="bg-white rounded-xl p-6 md:p-8 shadow-lg animate-fadeIn">
                <h2 class="text-2xl font-bold text-neutral-700 mb-6 flex items-center">
                    <i class="fa fa-gift text-secondary mr-3"></i>积分兑换
                </h2>
                
                <div class="flex flex-wrap gap-3 mb-6">
                    <button id="add-reward" class="bg-primary hover:bg-primary/90 text-white font-medium py-2 px-4 rounded-lg flex items-center shadow hover:shadow-md transition-all">
                        <i class="fa fa-plus mr-2"></i>添加奖品
                    </button>
                    <button id="delete-selected-rewards" class="bg-danger hover:bg-danger/90 text-white font-medium py-2 px-4 rounded-lg flex items-center shadow hover:shadow-md transition-all">
                        <i class="fa fa-trash mr-2"></i>删除选中
                    </button>
                    <button id="set-reward-points" class="bg-neutral-600 hover:bg-neutral-700 text-white font-medium py-2 px-4 rounded-lg flex items-center shadow hover:shadow-md transition-all">
                        <i class="fa fa-edit mr-2"></i>设置积分
                    </button>
                </div>
                
                <div class="mb-8">
                    <h3 class="text-lg font-semibold mb-3 text-neutral-600">奖品列表</h3>
                    <div id="rewards-list" class="space-y-3 max-h-[400px] overflow-y-auto pr-2">
                        <div class="text-neutral-400 text-center py-8 border-2 border-dashed rounded-lg">
                            暂无奖品，请添加奖品
                        </div>
                    </div>
                </div>
                
                <div>
                    <h3 class="text-lg font-semibold mb-3 text-neutral-600">兑换记录</h3>
                    <div id="redeem-history" class="space-y-2 max-h-[200px] overflow-y-auto pr-2 text-sm">
                        <div class="text-neutral-400 text-center py-4 border-2 border-dashed rounded-lg">
                            暂无兑换记录
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- 3. 积分任务板块 -->
        <section id="tasks-section" class="hidden">
            <div class="bg-white rounded-xl p-6 md:p-8 shadow-lg animate-fadeIn">
                <h2 class="text-2xl font-bold text-neutral-700 mb-6 flex items-center">
                    <i class="fa fa-tasks text-secondary mr-3"></i>积分任务
                </h2>
                
                <div class="flex flex-wrap gap-3 mb-6">
                    <button id="add-task" class="bg-primary hover:bg-primary/90 text-white font-medium py-2 px-4 rounded-lg flex items-center shadow hover:shadow-md transition-all">
                        <i class="fa fa-plus mr-2"></i>添加任务
                    </button>
                    <button id="delete-selected-tasks" class="bg-danger hover:bg-danger/90 text-white font-medium py-2 px-4 rounded-lg flex items-center shadow hover:shadow-md transition-all">
                        <i class="fa fa-trash mr-2"></i>删除选中
                    </button>
                    <button id="set-task-points" class="bg-neutral-600 hover:bg-neutral-700 text-white font-medium py-2 px-4 rounded-lg flex items-center shadow hover:shadow-md transition-all">
                        <i class="fa fa-edit mr-2"></i>更改积分
                    </button>
                </div>
                
                <div>
                    <h3 class="text-lg font-semibold mb-3 text-neutral-600">任务列表</h3>
                    <div id="tasks-list" class="space-y-3 max-h-[500px] overflow-y-auto pr-2">
                        <div class="text-neutral-400 text-center py-8 border-2 border-dashed rounded-lg">
                            暂无任务，请添加任务
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- 页脚 -->
    <footer class="bg-white border-t border-neutral-200 py-4 mt-8">
        <div class="container mx-auto px-4 text-center text-neutral-500 text-sm">
            <p>数据存储在 GitHub Gist | <span id="last-sync">从未同步</span></p>
        </div>
    </footer>

    <!-- 模态框 -->
    <div id="modal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4 animate-fadeIn">
            <h3 id="modal-title" class="text-xl font-bold mb-4 text-neutral-700">添加</h3>
            
            <div class="space-y-4">
                <div>
                    <label for="item-name" class="block text-sm font-medium text-neutral-600 mb-1">名称</label>
                    <input type="text" id="item-name" class="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all" placeholder="输入名称">
                </div>
                
                <div>
                    <label for="item-points" class="block text-sm font-medium text-neutral-600 mb-1">所需积分</label>
                    <input type="number" id="item-points" class="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all" placeholder="输入积分" min="1">
                </div>
            </div>
            
            <div class="mt-6 flex justify-end space-x-3">
                <button id="modal-cancel" class="px-4 py-2 border border-neutral-300 rounded-lg text-neutral-700 hover:bg-neutral-100 transition-colors">取消</button>
                <button id="modal-confirm" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">确认</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== GitHub Gist API 管理器 ====================
        const GitHubAPI = {
            token: null,
            gistId: null,
            data: null,
            syncTimeout: null,
            
            // 初始化
            init(token, gistId) {
                this.token = token;
                this.gistId = gistId;
                return this.loadData();
            },
            
            // 从 Gist 加载数据
            async loadData() {
                try {
                    this.showSyncStatus('syncing', '同步中...');
                    
                    const response = await fetch(`https://api.github.com/gists/${this.gistId}`, {
                        headers: {
                            'Authorization': `token ${this.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const gist = await response.json();
                    const content = gist.files['point-system-data.json'].content;
                    this.data = JSON.parse(content);
                    
                    this.showSyncStatus('synced', '已同步');
                    this.updateLastSyncTime();
                    return this.data;
                    
                } catch (error) {
                    console.error('加载数据失败:', error);
                    this.showSyncStatus('error', '同步失败');
                    throw error;
                }
            },
            
            // 保存数据到 Gist
            async saveData() {
                if (!this.token || !this.gistId) return;
                
                // 防抖，避免频繁保存
                clearTimeout(this.syncTimeout);
                this.syncTimeout = setTimeout(async () => {
                    try {
                        this.showSyncStatus('syncing', '保存中...');
                        
                        this.data.lastUpdated = new Date().toISOString();
                        
                        const response = await fetch(`https://api.github.com/gists/${this.gistId}`, {
                            method: 'PATCH',
                            headers: {
                                'Authorization': `token ${this.token}`,
                                'Accept': 'application/vnd.github.v3+json',
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                files: {
                                    'point-system-data.json': {
                                        content: JSON.stringify(this.data, null, 2)
                                    }
                                }
                            })
                        });
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}`);
                        }
                        
                        this.showSyncStatus('synced', '已保存');
                        this.updateLastSyncTime();
                        
                    } catch (error) {
                        console.error('保存失败:', error);
                        this.showSyncStatus('error', '保存失败');
                    }
                }, 500); // 延迟 500ms 保存，避免频繁请求
            },
            
            // 获取数据
            getData() {
                return this.data || {
                    points: 0,
                    rewards: [],
                    tasks: [],
                    redeemHistory: [],
                    lastUpdated: new Date().toISOString()
                };
            },
            
            // 更新数据
            updateData(newData) {
                this.data = { ...this.data, ...newData };
                this.saveData();
            },
            
            // 显示同步状态
            showSyncStatus(type, message) {
                const statusEl = document.getElementById('sync-status');
                statusEl.className = `sync-status ${type}`;
                statusEl.innerHTML = `<i class="fa fa-${type === 'syncing' ? 'refresh fa-spin' : type === 'synced' ? 'check-circle' : 'exclamation-circle'} mr-1"></i>${message}`;
                statusEl.classList.remove('hidden');
                
                if (type === 'synced') {
                    setTimeout(() => {
                        statusEl.classList.add('hidden');
                    }, 2000);
                }
            },
            
            // 更新最后同步时间
            updateLastSyncTime() {
                const timeEl = document.getElementById('last-sync');
                const now = new Date();
                timeEl.textContent = `最后同步: ${now.toLocaleTimeString()}`;
            }
        };

        // ==================== 数据管理器 ====================
        const DataManager = {
            // 积分相关
            getPoints() {
                return GitHubAPI.getData().points || 0;
            },
            
            setPoints(points) {
                GitHubAPI.updateData({ points });
                return points;
            },
            
            addPoint() {
                const points = this.getPoints() + 1;
                return this.setPoints(points);
            },
            
            subtractPoint() {
                let points = this.getPoints();
                if (points > 0) {
                    points -= 1;
                    return this.setPoints(points);
                }
                return points;
            },
            
            // 奖品相关
            getRewards() {
                return GitHubAPI.getData().rewards || [];
            },
            
            addReward(name, points) {
                const rewards = this.getRewards();
                const newReward = {
                    id: Date.now(),
                    name,
                    points: parseInt(points),
                    selected: false
                };
                rewards.push(newReward);
                GitHubAPI.updateData({ rewards });
                return newReward;
            },
            
            updateRewardPoints(id, points) {
                const rewards = this.getRewards();
                const index = rewards.findIndex(r => r.id === id);
                if (index !== -1) {
                    rewards[index].points = parseInt(points);
                    GitHubAPI.updateData({ rewards });
                    return rewards[index];
                }
                return null;
            },
            
            deleteSelectedRewards() {
                const rewards = this.getRewards();
                const remaining = rewards.filter(r => !r.selected);
                GitHubAPI.updateData({ rewards: remaining });
                return remaining;
            },
            
            toggleRewardSelection(id) {
                const rewards = this.getRewards();
                const index = rewards.findIndex(r => r.id === id);
                if (index !== -1) {
                    rewards[index].selected = !rewards[index].selected;
                    GitHubAPI.updateData({ rewards });
                    return rewards[index];
                }
                return null;
            },
            
            // 兑换记录相关
            getRedeemHistory() {
                return GitHubAPI.getData().redeemHistory || [];
            },
            
            addRedeemRecord(reward) {
                const history = this.getRedeemHistory();
                const record = {
                    id: Date.now(),
                    rewardName: reward.name,
                    points: reward.points,
                    date: new Date().toLocaleString()
                };
                history.push(record);
                GitHubAPI.updateData({ redeemHistory: history });
                return record;
            },
            
            // 任务相关
            getTasks() {
                return GitHubAPI.getData().tasks || [];
            },
            
            addTask(name, points) {
                const tasks = this.getTasks();
                const newTask = {
                    id: Date.now(),
                    name,
                    points: parseInt(points),
                    selected: false
                };
                tasks.push(newTask);
                GitHubAPI.updateData({ tasks });
                return newTask;
            },
            
            updateTaskPoints(id, points) {
                const tasks = this.getTasks();
                const index = tasks.findIndex(t => t.id === id);
                if (index !== -1) {
                    tasks[index].points = parseInt(points);
                    GitHubAPI.updateData({ tasks });
                    return tasks[index];
                }
                return null;
            },
            
            deleteSelectedTasks() {
                const tasks = this.getTasks();
                const remaining = tasks.filter(t => !t.selected);
                GitHubAPI.updateData({ tasks: remaining });
                return remaining;
            },
            
            toggleTaskSelection(id) {
                const tasks = this.getTasks();
                const index = tasks.findIndex(t => t.id === id);
                if (index !== -1) {
                    tasks[index].selected = !tasks[index].selected;
                    GitHubAPI.updateData({ tasks });
                    return tasks[index];
                }
                return null;
            },
            
            deleteTask(id) {
                const tasks = this.getTasks();
                const remaining = tasks.filter(t => t.id !== id);
                GitHubAPI.updateData({ tasks: remaining });
                return remaining;
            }
        };

        // ==================== UI 控制器 ====================
        const UIController = {
            init() {
                this.setupEventListeners();
                this.checkLogin();
            },
            
            checkLogin() {
                const token = localStorage.getItem('github_token');
                const gistId = localStorage.getItem('gist_id');
                
                if (token && gistId) {
                    this.login(token, gistId);
                } else {
                    document.getElementById('login-modal').classList.remove('hidden');
                }
            },
            
            async login(token, gistId) {
                const loginBtn = document.getElementById('login-btn');
                loginBtn.innerHTML = '<div class="loading mr-2"></div>连接中...';
                loginBtn.disabled = true;
                
                try {
                    await GitHubAPI.init(token, gistId);
                    
                    // 保存到本地（仅用于下次自动登录）
                    localStorage.setItem('github_token', token);
                    localStorage.setItem('gist_id', gistId);
                    
                    document.getElementById('login-modal').classList.add('hidden');
                    this.updateUI();
                    
                } catch (error) {
                    alert('连接失败: ' + error.message);
                    loginBtn.innerHTML = '<span>连接并同步</span>';
                    loginBtn.disabled = false;
                }
            },
            
            logout() {
                localStorage.removeItem('github_token');
                localStorage.removeItem('gist_id');
                location.reload();
            },
            
            updateUI() {
                this.updatePointsDisplay();
                this.renderRewardsList();
                this.renderRedeemHistory();
                this.renderTasksList();
            },
            
            updatePointsDisplay() {
                const pointsEl = document.getElementById('current-points');
                const points = DataManager.getPoints();
                pointsEl.textContent = points;
                pointsEl.classList.add('point-change');
                setTimeout(() => {
                    pointsEl.classList.remove('point-change');
                }, 500);
            },
            
            renderRewardsList() {
                const rewardsListEl = document.getElementById('rewards-list');
                const rewards = DataManager.getRewards();
                
                if (rewards.length === 0) {
                    rewardsListEl.innerHTML = `
                        <div class="text-neutral-400 text-center py-8 border-2 border-dashed rounded-lg">
                            暂无奖品，请添加奖品
                        </div>
                    `;
                    return;
                }
                
                rewardsListEl.innerHTML = rewards.map(reward => `
                    <div class="flex items-center justify-between p-3 border-2 ${reward.selected ? 'border-primary bg-primary/5' : 'border-neutral-200'} rounded-lg hover:shadow-md transition-shadow">
                        <div class="flex items-center space-x-3">
                            <input type="checkbox" ${reward.selected ? 'checked' : ''} data-id="${reward.id}" class="reward-checkbox w-5 h-5 text-primary rounded focus:ring-primary cursor-pointer">
                            <span class="font-medium">${reward.name}</span>
                        </div>
                        <div class="flex items-center space-x-4">
                            <span class="text-primary font-semibold">${reward.points} 积分</span>
                            <button class="redeem-btn bg-secondary hover:bg-secondary/90 text-white p-2 rounded-full shadow hover:shadow-md transition-all transform hover:scale-110" data-id="${reward.id}">
                                <i class="fa fa-exchange"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            },
            
            renderRedeemHistory() {
                const historyEl = document.getElementById('redeem-history');
                const history = DataManager.getRedeemHistory();
                
                if (history.length === 0) {
                    historyEl.innerHTML = `
                        <div class="text-neutral-400 text-center py-4 border-2 border-dashed rounded-lg">
                            暂无兑换记录
                        </div>
                    `;
                    return;
                }
                
                history.sort((a, b) => b.id - a.id);
                
                historyEl.innerHTML = history.map(record => `
                    <div class="p-3 border border-neutral-200 rounded-lg text-sm bg-neutral-50">
                        <div class="flex justify-between items-center">
                            <span class="font-medium">${record.rewardName}</span>
                            <span class="text-danger font-semibold">-${record.points} 积分</span>
                        </div>
                        <div class="text-neutral-500 mt-1 text-xs">${record.date}</div>
                    </div>
                `).join('');
            },
            
            renderTasksList() {
                const tasksListEl = document.getElementById('tasks-list');
                const tasks = DataManager.getTasks();
                
                if (tasks.length === 0) {
                    tasksListEl.innerHTML = `
                        <div class="text-neutral-400 text-center py-8 border-2 border-dashed rounded-lg">
                            暂无任务，请添加任务
                        </div>
                    `;
                    return;
                }
                
                tasksListEl.innerHTML = tasks.map(task => `
                    <div class="flex items-center justify-between p-3 border-2 ${task.selected ? 'border-primary bg-primary/5' : 'border-neutral-200'} rounded-lg hover:shadow-md transition-shadow">
                        <div class="flex items-center space-x-3">
                            <input type="checkbox" ${task.selected ? 'checked' : ''} data-id="${task.id}" class="task-checkbox w-5 h-5 text-primary rounded focus:ring-primary cursor-pointer">
                            <span class="font-medium">${task.name}</span>
                        </div>
                        <div class="flex items-center space-x-4">
                            <span class="text-success font-semibold">+${task.points} 积分</span>
                            <button class="complete-task-btn bg-success hover:bg-success/90 text-white p-2 rounded-full shadow hover:shadow-md transition-all transform hover:scale-110" data-id="${task.id}">
                                <i class="fa fa-check"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            },
            
            showModal(title, callback) {
                const modalEl = document.getElementById('modal');
                const modalTitleEl = document.getElementById('modal-title');
                const nameInputEl = document.getElementById('item-name');
                const pointsInputEl = document.getElementById('item-points');
                
                modalTitleEl.textContent = title;
                nameInputEl.value = '';
                pointsInputEl.value = '';
                modalEl.classList.remove('hidden');
                
                modalEl.dataset.callback = 'modalCallback_' + Date.now();
                window[modalEl.dataset.callback] = callback;
                
                setTimeout(() => nameInputEl.focus(), 100);
            },
            
            hideModal() {
                const modalEl = document.getElementById('modal');
                modalEl.classList.add('hidden');
                if (modalEl.dataset.callback && window[modalEl.dataset.callback]) {
                    delete window[modalEl.dataset.callback];
                }
            },
            
            switchSection(section) {
                ['points', 'redeem', 'tasks'].forEach(s => {
                    document.getElementById(`${s}-section`).classList.add('hidden');
                });
                document.getElementById(`${section}-section`).classList.remove('hidden');
                
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.classList.remove('active', 'border-primary', 'text-primary');
                    btn.classList.add('border-transparent');
                });
                document.getElementById(`nav-${section}`)?.classList.add('active', 'border-primary', 'text-primary');
                
                document.querySelectorAll('.mobile-nav-btn').forEach(btn => {
                    btn.classList.remove('active', 'bg-primary/10', 'text-primary');
                });
                document.getElementById(`mobile-nav-${section}`)?.classList.add('active', 'bg-primary/10', 'text-primary');
            },
            
            setupEventListeners() {
                // 登录
                document.getElementById('login-btn').addEventListener('click', () => {
                    const token = document.getElementById('github-token').value.trim();
                    const gistId = document.getElementById('gist-id').value.trim();
                    
                    if (!token || !gistId) {
                        alert('请输入 Token 和 Gist ID');
                        return;
                    }
                    
                    this.login(token, gistId);
                });
                
                // 退出
                document.getElementById('logout-btn').addEventListener('click', () => this.logout());
                
                // 手动同步
                document.getElementById('sync-btn').addEventListener('click', async () => {
                    await GitHubAPI.loadData();
                    this.updateUI();
                });
                
                // 导航
                document.getElementById('nav-points').addEventListener('click', () => this.switchSection('points'));
                document.getElementById('nav-redeem').addEventListener('click', () => this.switchSection('redeem'));
                document.getElementById('nav-tasks').addEventListener('click', () => this.switchSection('tasks'));
                
                // 移动端导航
                document.getElementById('mobile-menu-btn').addEventListener('click', () => {
                    document.getElementById('mobile-menu').classList.toggle('hidden');
                });
                
                document.getElementById('mobile-nav-points').addEventListener('click', () => {
                    this.switchSection('points');
                    document.getElementById('mobile-menu').classList.add('hidden');
                });
                
                document.getElementById('mobile-nav-redeem').addEventListener('click', () => {
                    this.switchSection('redeem');
                    document.getElementById('mobile-menu').classList.add('hidden');
                });
                
                document.getElementById('mobile-nav-tasks').addEventListener('click', () => {
                    this.switchSection('tasks');
                    document.getElementById('mobile-menu').classList.add('hidden');
                });
                
                // 积分操作
                document.getElementById('add-point').addEventListener('click', () => {
                    DataManager.addPoint();
                    this.updatePointsDisplay();
                });
                
                document.getElementById('subtract-point').addEventListener('click', () => {
                    DataManager.subtractPoint();
                    this.updatePointsDisplay();
                });
                
                // 奖品操作
                document.getElementById('add-reward').addEventListener('click', () => {
                    this.showModal('添加奖品', (name, points) => {
                        DataManager.addReward(name, points);
                        this.renderRewardsList();
                    });
                });
                
                document.getElementById('delete-selected-rewards').addEventListener('click', () => {
                    DataManager.deleteSelectedRewards();
                    this.renderRewardsList();
                });
                
                document.getElementById('set-reward-points').addEventListener('click', () => {
                    const rewards = DataManager.getRewards();
                    const selected = rewards.filter(r => r.selected);
                    
                    if (selected.length !== 1) {
                        alert('请选择一个奖品进行设置');
                        return;
                    }
                    
                    const reward = selected[0];
                    this.showModal('设置奖品积分', (name, points) => {
                        DataManager.updateRewardPoints(reward.id, points);
                        this.renderRewardsList();
                    });
                    
                    setTimeout(() => {
                        document.getElementById('item-name').value = reward.name;
                        document.getElementById('item-points').value = reward.points;
                    }, 100);
                });
                
                // 奖品列表事件
                document.getElementById('rewards-list').addEventListener('click', (e) => {
                    if (e.target.classList.contains('reward-checkbox')) {
                        const id = parseInt(e.target.dataset.id);
                        DataManager.toggleRewardSelection(id);
                        this.renderRewardsList();
                    }
                    
                    if (e.target.closest('.redeem-btn')) {
                        const btn = e.target.closest('.redeem-btn');
                        const id = parseInt(btn.dataset.id);
                        const rewards = DataManager.getRewards();
                        const reward = rewards.find(r => r.id === id);
                        
                        if (!reward) return;
                        
                        const currentPoints = DataManager.getPoints();
                        if (currentPoints >= reward.points) {
                            DataManager.setPoints(currentPoints - reward.points);
                            DataManager.addRedeemRecord(reward);
                            this.updatePointsDisplay();
                            this.renderRedeemHistory();
                            alert(`成功兑换：${reward.name}`);
                        } else {
                            alert('积分不足，无法兑换');
                        }
                    }
                });
                
                // 任务操作
                document.getElementById('add-task').addEventListener('click', () => {
                    this.showModal('添加任务', (name, points) => {
                        DataManager.addTask(name, points);
                        this.renderTasksList();
                    });
                });
                
                document.getElementById('delete-selected-tasks').addEventListener('click', () => {
                    DataManager.deleteSelectedTasks();
                    this.renderTasksList();
                });
                
                document.getElementById('set-task-points').addEventListener('click', () => {
                    const tasks = DataManager.getTasks();
                    const selected = tasks.filter(t => t.selected);
                    
                    if (selected.length !== 1) {
                        alert('请选择一个任务进行设置');
                        return;
                    }
                    
                    const task = selected[0];
                    this.showModal('更改任务积分', (name, points) => {
                        DataManager.updateTaskPoints(task.id, points);
                        this.renderTasksList();
                    });
                    
                    setTimeout(() => {
                        document.getElementById('item-name').value = task.name;
                        document.getElementById('item-points').value = task.points;
                    }, 100);
                });
                
                // 任务列表事件
                document.getElementById('tasks-list').addEventListener('click', (e) => {
                    if (e.target.classList.contains('task-checkbox')) {
                        const id = parseInt(e.target.dataset.id);
                        DataManager.toggleTaskSelection(id);
                        this.renderTasksList();
                    }
                    
                    if (e.target.closest('.complete-task-btn')) {
                        const btn = e.target.closest('.complete-task-btn');
                        const id = parseInt(btn.dataset.id);
                        const tasks = DataManager.getTasks();
                        const task = tasks.find(t => t.id === id);
                        
                        if (!task) return;
                        
                        DataManager.setPoints(DataManager.getPoints() + task.points);
                        DataManager.deleteTask(id);
                        this.updatePointsDisplay();
                        this.renderTasksList();
                        alert(`完成任务：${task.name}，获得 ${task.points} 积分`);
                    }
                });
                
                // 模态框
                document.getElementById('modal-cancel').addEventListener('click', () => this.hideModal());
                
                document.getElementById('modal-confirm').addEventListener('click', () => {
                    const name = document.getElementById('item-name').value.trim();
                    const points = document.getElementById('item-points').value.trim();
                    
                    if (!name) {
                        alert('请输入名称');
                        return;
                    }
                    
                    if (!points || isNaN(points) || parseInt(points) <= 0) {
                        alert('请输入有效的积分值');
                        return;
                    }
                    
                    const modalEl = document.getElementById('modal');
                    if (modalEl.dataset.callback && window[modalEl.dataset.callback]) {
                        window[modalEl.dataset.callback](name, points);
                    }
                    
                    this.hideModal();
                });
                
                document.getElementById('modal').addEventListener('click', (e) => {
                    if (e.target === document.getElementById('modal')) {
                        this.hideModal();
                    }
                });
                
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && !document.getElementById('modal').classList.contains('hidden')) {
                        this.hideModal();
                    }
                });
            }
        };

        // 启动应用
        document.addEventListener('DOMContentLoaded', () => {
            UIController.init();
        });
    </script>
</body>
</html>